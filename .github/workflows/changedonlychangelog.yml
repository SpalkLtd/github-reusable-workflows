name: Changed only changelog
on:
    workflow_call:
        inputs:
            owner_repo:
                description: 'Github owner repo string (SpalkLtd/synchroniser)'
                required: true
                type: string
            pr_num:
                description: 'Github pr number'
                required: true
                type: string
        secrets:
            githubToken:
                description: 'Github token passed from the caller workflow'
                required: true
        outputs:
            changelog_only:
                description: "True iff CHANGELOG.md was the only file that changed for the PR"
                value: ${{ jobs.check_changelog.outputs.changelog_only }}

jobs:
  check_changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog_only: ${{ steps.set_output.outputs.changelog_only }}
    steps:
      - name: Get file list from GH API
        id: get_file_data
        env:
          GITHUB_TOKEN: ${{ secrets.githubToken }}
          OWNER_REPO: ${{ inputs.owner_repo }}
          PR_NUM: ${{ inputs.pr_num }}
        run: |
          echo "file_list=$(curl -H 'Accept: application/vnd.github.v3+json' -H "Authorization: Bearer $GITHUB_TOKEN" "https://api.github.com/repos/$OWNER_REPO/pulls/$PR_NUM/files" | jq -r '[.[].filename] | join(" ")')" >> $GITHUB_OUTPUT
      - name: Log API call
        env:
          OWNER_REPO: ${{ inputs.owner_repo }}
          PR_NUM: ${{ inputs.pr_num }}
        run: 'echo "URL called: GET /repos/$OWNER_REPO/pulls/$PR_NUM/files"'
      - name: Set output vars
        id: set_output
        env:
          FILE_LIST: ${{ steps.get_file_data.outputs.file_list }}
        run: '[[ "$FILE_LIST" == "CHANGELOG.md" ]] && echo "changelog_only=true" >> $GITHUB_OUTPUT || echo "changelog_only=false" >> $GITHUB_OUTPUT'